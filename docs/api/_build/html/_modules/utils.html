<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>utils &mdash; Kore 1.1.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=83302504"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Kore
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">MODULES</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../utils.html">utils</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Kore</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">scipy.linalg</span> <span class="k">as</span> <span class="nn">las</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">so</span>
<span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">ss</span>
<span class="kn">import</span> <span class="nn">scipy.special</span> <span class="k">as</span> <span class="nn">scsp</span>
<span class="kn">import</span> <span class="nn">scipy.fftpack</span> <span class="k">as</span> <span class="nn">sft</span>
<span class="kn">import</span> <span class="nn">numpy.polynomial.chebyshev</span> <span class="k">as</span> <span class="nn">ch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">parameters</span> <span class="k">as</span> <span class="nn">par</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">warnings</span> <span class="kn">import</span> <span class="n">warn</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">A library of various function definitions and utilities</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># First some global variables: -----------------------------------------------------------------------------------------</span>
<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>

<span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">forcing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">wf</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">wf</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">forcing_frequency</span>

<span class="n">rcmb</span>   <span class="o">=</span> <span class="mi">1</span>

<span class="n">N1</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">))</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">))</span> <span class="c1"># N/2 if no IC, N if present</span>
<span class="n">n</span>      <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">N1</span><span class="o">*</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">lmax</span><span class="o">-</span><span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">n0</span>     <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="o">*</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">lmax</span><span class="o">-</span><span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="n">m</span>      <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span>
<span class="n">lmax</span>   <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">lmax</span>
<span class="n">vsymm</span>  <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">symm</span>

<span class="n">symm1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">symm</span>  <span class="c1"># symm1=par.symm if m&gt;0, symm1 = -par.symm if m=0</span>

<span class="c1"># this gives the size (rows or columns) of the main matrices</span>
<span class="n">sizmat</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">par</span><span class="o">.</span><span class="n">hydro</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">*</span><span class="n">par</span><span class="o">.</span><span class="n">magnetic</span> <span class="o">+</span> <span class="n">n</span><span class="o">*</span><span class="n">par</span><span class="o">.</span><span class="n">thermal</span> <span class="o">+</span> <span class="n">n</span><span class="o">*</span><span class="n">par</span><span class="o">.</span><span class="n">compositional</span>

<span class="n">s</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">vsymm</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span> <span class="c1"># s=0 if antisymm, s=1 if symm</span>
<span class="n">m_top</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="o">-</span><span class="n">s</span>
<span class="n">m_bot</span> <span class="o">=</span> <span class="n">m</span> <span class="o">+</span> <span class="n">s</span>
<span class="k">if</span> <span class="n">m_top</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">m_top</span> <span class="o">=</span> <span class="mi">2</span>
<span class="k">if</span> <span class="n">m_bot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">m_bot</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">lmax_top</span> <span class="o">=</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="o">*</span><span class="n">s</span>
<span class="n">lmax_bot</span> <span class="o">=</span> <span class="n">lmax</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">m</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">s</span><span class="p">)</span>

<span class="n">beta_actual</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">B0</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;axial&#39;</span><span class="p">,</span><span class="s1">&#39;dipole&#39;</span><span class="p">,</span><span class="s1">&#39;G21 dipole&#39;</span><span class="p">,</span><span class="s1">&#39;Luo_S1&#39;</span><span class="p">]:</span>
    <span class="n">symmB0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">B0_l</span>   <span class="o">=</span>  <span class="mi">1</span>
<span class="k">elif</span> <span class="n">par</span><span class="o">.</span><span class="n">B0</span> <span class="o">==</span> <span class="s1">&#39;Luo_S2&#39;</span><span class="p">:</span>
    <span class="n">symmB0</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">B0_l</span>   <span class="o">=</span> <span class="mi">2</span>
<span class="k">elif</span> <span class="n">par</span><span class="o">.</span><span class="n">B0</span> <span class="o">==</span> <span class="s1">&#39;FDM&#39;</span><span class="p">:</span>
    <span class="n">symmB0</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">par</span><span class="o">.</span><span class="n">B0_l</span><span class="p">)</span>
    <span class="n">B0_l</span>   <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">B0_l</span>

<span class="n">bsymm</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">symm</span> <span class="o">*</span> <span class="n">symmB0</span>  <span class="c1"># induced magnetic field (b) symmetry follows from u and B0</span>

<span class="n">B0list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;axial&#39;</span><span class="p">,</span> <span class="s1">&#39;dipole&#39;</span><span class="p">,</span> <span class="s1">&#39;G21 dipole&#39;</span><span class="p">,</span> <span class="s1">&#39;Luo_S1&#39;</span><span class="p">,</span> <span class="s1">&#39;Luo_S2&#39;</span><span class="p">,</span> <span class="s1">&#39;FDM&#39;</span><span class="p">]</span>
<span class="n">B0type</span> <span class="o">=</span> <span class="n">B0list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">B0</span><span class="p">)</span>

<span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">innercore</span> <span class="o">==</span> <span class="s1">&#39;insulator&#39;</span><span class="p">:</span>
    <span class="n">innercore_mag_bc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">elif</span> <span class="n">par</span><span class="o">.</span><span class="n">innercore</span> <span class="o">==</span> <span class="s1">&#39;TWA&#39;</span><span class="p">:</span>
    <span class="n">innercore_mag_bc</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">mantle</span> <span class="o">==</span> <span class="s1">&#39;insulator&#39;</span><span class="p">:</span>
    <span class="n">mantle_mag_bc</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">elif</span> <span class="n">par</span><span class="o">.</span><span class="n">mantle</span> <span class="o">==</span> <span class="s1">&#39;TWA&#39;</span><span class="p">:</span>
    <span class="n">mantle_mag_bc</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">thermal_heating_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;internal&#39;</span><span class="p">,</span> <span class="s1">&#39;differential&#39;</span><span class="p">,</span> <span class="s1">&#39;two zone&#39;</span><span class="p">,</span> <span class="s1">&#39;user defined&#39;</span><span class="p">]</span>
<span class="n">heating</span> <span class="o">=</span> <span class="n">thermal_heating_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">heating</span><span class="p">)</span>

<span class="n">compositional_background_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;internal&#39;</span><span class="p">,</span> <span class="s1">&#39;differential&#39;</span><span class="p">]</span>
<span class="n">compositional_background</span> <span class="o">=</span> <span class="n">compositional_background_list</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">comp_background</span><span class="p">)</span>

<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>
<span class="c1"># ----------------------------------------------------------------------------------------------------------------------</span>



<div class="viewcode-block" id="decode_label">
<a class="viewcode-back" href="../utils.html#utils.decode_label">[docs]</a>
<span class="k">def</span> <span class="nf">decode_label</span><span class="p">(</span> <span class="n">labl</span> <span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the stripped label, the indices rx, hx, dx, the section,</span>
<span class="sd">    and up to two profile identifiers with their corresponding derivative order</span>
<span class="sd">    [ lablx, rx, hx, dx, section, profid1, dp1, profid2, dp2 ]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="p">[</span> <span class="n">lablx</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">profid1</span><span class="p">,</span> <span class="n">dp1</span><span class="p">,</span> <span class="n">profid2</span><span class="p">,</span> <span class="n">dp2</span> <span class="p">]</span> <span class="o">=</span> <span class="p">[</span> <span class="kc">None</span> <span class="p">]</span><span class="o">*</span><span class="mi">9</span>

    <span class="n">lablx</span> <span class="o">=</span> <span class="n">labl</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># label without the section</span>

    <span class="k">if</span> <span class="n">labl</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;q1&#39;</span><span class="p">:</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="mi">6</span>  <span class="c1"># this is an index, not a power, it corresponds to r**-1</span>
    <span class="k">elif</span> <span class="n">labl</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
        <span class="n">rx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labl</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>  <span class="c1"># index of the power of r</span>

    <span class="n">dx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labl</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>  <span class="c1"># operator&#39;s derivative order</span>
    <span class="n">section</span> <span class="o">=</span> <span class="n">labl</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>    <span class="c1"># section</span>

    <span class="k">if</span>   <span class="nb">len</span><span class="p">(</span><span class="n">labl</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>  <span class="c1"># h is there</span>

        <span class="n">hx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labl</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labl</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">]:</span>   <span class="c1"># h and at least 1 profile</span>
            <span class="n">profid1</span> <span class="o">=</span> <span class="n">labl</span><span class="p">[</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
            <span class="n">dp1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labl</span><span class="p">[</span><span class="mi">9</span><span class="p">])</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">20</span><span class="p">:</span>      <span class="c1"># h and 2 profiles, e.g. &#39;r1_h0_rho2_eta1_D0_f&#39;</span>
                <span class="n">profid1</span> <span class="o">=</span> <span class="n">labl</span><span class="p">[</span><span class="mi">11</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span>
                <span class="n">dp1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labl</span><span class="p">[</span><span class="mi">14</span><span class="p">])</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">labl</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">12</span><span class="p">,</span> <span class="mi">17</span><span class="p">]:</span>  <span class="c1"># no h and at least 1 profile</span>

        <span class="n">profid1</span> <span class="o">=</span> <span class="n">labl</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">dp1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labl</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">labl</span><span class="p">)</span> <span class="o">==</span> <span class="mi">17</span><span class="p">:</span>  <span class="c1"># no h and 2 profiles, e.g. &#39;r0_rho1_eta3_D2_u&#39;</span>

            <span class="n">profid2</span> <span class="o">=</span> <span class="n">labl</span><span class="p">[</span><span class="mi">8</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span>
            <span class="n">dp2</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">labl</span><span class="p">[</span><span class="mi">11</span><span class="p">])</span>

    <span class="k">return</span> <span class="p">[</span> <span class="n">lablx</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">hx</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">profid1</span><span class="p">,</span> <span class="n">dp1</span><span class="p">,</span> <span class="n">profid2</span><span class="p">,</span> <span class="n">dp2</span> <span class="p">]</span></div>




<div class="viewcode-block" id="labelit">
<a class="viewcode-back" href="../utils.html#utils.labelit">[docs]</a>
<span class="k">def</span> <span class="nf">labelit</span><span class="p">(</span> <span class="n">labl</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">rplus</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Appends a section string to each label in the list labl.</span>
<span class="sd">    Optionally, it increases the r power in each label by rplus.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">labl1</span> <span class="ow">in</span> <span class="n">labl</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">rplus</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>  <span class="c1"># increase the power of r in the label by rplus:</span>

            <span class="n">old_rpow</span> <span class="o">=</span> <span class="n">labl1</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">r_or_q</span> <span class="o">=</span> <span class="n">old_rpow</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">old_rpow</span> <span class="o">==</span> <span class="s1">&#39;q1&#39;</span><span class="p">:</span>
                <span class="n">orpw</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="n">r_or_q</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">orpw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">old_rpow</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

            <span class="n">new_rpow</span> <span class="o">=</span> <span class="n">r_or_q</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span> <span class="n">orpw</span> <span class="o">+</span> <span class="n">rplus</span> <span class="p">)</span>
            <span class="n">labl1</span> <span class="o">=</span> <span class="n">labl1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">old_rpow</span><span class="p">,</span> <span class="n">new_rpow</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># append the appropriate section string</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span> <span class="n">labl1</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">section</span> <span class="p">]</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="packit">
<a class="viewcode-back" href="../utils.html#utils.packit">[docs]</a>
<span class="k">def</span> <span class="nf">packit</span><span class="p">(</span> <span class="n">lista_local</span><span class="p">,</span> <span class="n">mtx</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Appends sparse matrix data, row, and col info to lista_local</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">mtx</span><span class="o">.</span><span class="n">eliminate_zeros</span><span class="p">()</span>
    <span class="n">mtx</span> <span class="o">=</span> <span class="n">mtx</span><span class="o">.</span><span class="n">tocoo</span><span class="p">()</span>
    <span class="n">blk</span> <span class="o">=</span> <span class="p">[</span><span class="n">mtx</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mtx</span><span class="o">.</span><span class="n">row</span> <span class="o">+</span> <span class="n">row</span><span class="p">,</span> <span class="n">mtx</span><span class="o">.</span><span class="n">col</span> <span class="o">+</span> <span class="n">col</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">lista_local</span><span class="p">[</span><span class="n">q</span><span class="p">]</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span> <span class="p">(</span> <span class="n">lista_local</span><span class="p">[</span><span class="n">q</span><span class="p">],</span> <span class="n">blk</span><span class="p">[</span><span class="n">q</span><span class="p">]</span> <span class="p">)</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">lista_local</span></div>




<span class="k">def</span> <span class="nf">ell</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">lmax</span><span class="p">,</span> <span class="n">vsymm</span><span class="p">)</span> <span class="p">:</span>
    <span class="c1"># Returns the l values for the poloidal flow (section u) and l values for toroidal flow (section v)</span>
    <span class="c1"># ll are *all* the l values and (idp,idt) are the indices for poloidals and toroidals respectively</span>
    <span class="n">lm1</span> <span class="o">=</span> <span class="n">lmax</span> <span class="o">-</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">s</span>   <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="n">vsymm</span><span class="o">*</span><span class="mf">0.5</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="p">)</span> <span class="c1"># s=0 if antisymm, s=1 if symm</span>
    <span class="n">idp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">+</span><span class="n">s</span>  <span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">lm1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">idt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">+</span><span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">lm1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">ll</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">lmax</span><span class="o">+</span><span class="mi">2</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">[</span> <span class="n">ll</span><span class="p">[</span><span class="n">idp</span><span class="p">],</span> <span class="n">ll</span><span class="p">[</span><span class="n">idt</span><span class="p">],</span> <span class="n">ll</span> <span class="p">]</span>



<div class="viewcode-block" id="remroco">
<a class="viewcode-back" href="../utils.html#utils.remroco">[docs]</a>
<span class="k">def</span> <span class="nf">remroco</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">overall_parity</span><span class="p">,</span> <span class="n">vector_parity</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Removes rows and cols from matrix according to parity</span>
<span class="sd">    overall_parity determines rows</span>
<span class="sd">    vector_parity determines cols</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">idj</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">overall_parity</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># overall_parity = 1 removes odd row indices</span>
    <span class="n">idk</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">vector_parity</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># vector_parity = 1 removes odd col indices</span>

    <span class="k">return</span> <span class="n">matrix</span><span class="p">[</span> <span class="n">idj</span><span class="p">::</span><span class="mi">2</span><span class="p">,</span> <span class="n">idk</span><span class="p">::</span><span class="mi">2</span> <span class="p">]</span></div>




<div class="viewcode-block" id="chebco_f">
<a class="viewcode-back" href="../utils.html#utils.chebco_f">[docs]</a>
<span class="k">def</span> <span class="nf">chebco_f</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">ricb</span><span class="p">,</span><span class="n">rcmb</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the first N Chebyshev coefficients</span>
<span class="sd">    from 0 to N-1, of func(r)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ricb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="p">(</span><span class="n">ricb</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcmb</span> <span class="o">-</span> <span class="n">ricb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">rcmb</span> <span class="o">*</span> <span class="n">xi</span>

    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sft</span><span class="o">.</span><span class="n">dct</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">ri</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sft</span><span class="o">.</span><span class="n">dct</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">args</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">N</span>
    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="chebco_rf">
<a class="viewcode-back" href="../utils.html#utils.chebco_rf">[docs]</a>
<span class="k">def</span> <span class="nf">chebco_rf</span><span class="p">(</span><span class="n">func</span><span class="p">,</span><span class="n">rpower</span><span class="p">,</span><span class="n">N</span><span class="p">,</span><span class="n">ricb</span><span class="p">,</span><span class="n">rcmb</span><span class="p">,</span><span class="n">tol</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the first N Chebyshev coefficients</span>
<span class="sd">    from 0 to N-1, of the function</span>
<span class="sd">    r**rpower * func(r)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ricb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="p">(</span><span class="n">ricb</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcmb</span> <span class="o">-</span> <span class="n">ricb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">rcmb</span> <span class="o">*</span> <span class="n">xi</span>

    <span class="k">if</span> <span class="n">args</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sft</span><span class="o">.</span><span class="n">dct</span><span class="p">(</span><span class="n">ri</span><span class="o">**</span><span class="n">rpower</span> <span class="o">*</span> <span class="n">func</span><span class="p">(</span><span class="n">ri</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sft</span><span class="o">.</span><span class="n">dct</span><span class="p">(</span><span class="n">ri</span><span class="o">**</span><span class="n">rpower</span> <span class="o">*</span> <span class="n">func</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span><span class="n">args</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">/</span> <span class="n">N</span>
    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="chebco">
<a class="viewcode-back" href="../utils.html#utils.chebco">[docs]</a>
<span class="k">def</span> <span class="nf">chebco</span><span class="p">(</span><span class="n">powr</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the first N Chebyshev coefficients</span>
<span class="sd">    from 0 to N-1, of the function</span>
<span class="sd">    ( ricb + (rcmb-ricb)*( x + 1 )/2. )**powr</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>                                    <span class="c1"># No inner core ---&gt; Chebyshev domain [-1,1] mapped to [-rcmb, rcmb]</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="p">(</span> <span class="n">rcmb</span><span class="o">*</span><span class="n">xi</span> <span class="p">)</span><span class="o">**</span><span class="n">powr</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ai</span> <span class="o">=</span> <span class="p">(</span> <span class="n">ricb</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcmb</span><span class="o">-</span><span class="n">ricb</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">xi</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.</span> <span class="p">)</span><span class="o">**</span><span class="n">powr</span>  <span class="c1"># With inner core -&gt; Chebyshev domain [-1,1] mapped to [ ricb, rcmb]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">sft</span><span class="o">.</span><span class="n">dct</span><span class="p">(</span><span class="n">ai</span><span class="p">)</span><span class="o">/</span><span class="n">N</span>
    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>
    <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">tol</span><span class="p">]</span><span class="o">=</span><span class="mf">0.</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="Dcheb">
<a class="viewcode-back" href="../utils.html#utils.Dcheb">[docs]</a>
<span class="k">def</span> <span class="nf">Dcheb</span><span class="p">(</span><span class="n">ck</span><span class="p">,</span> <span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The derivative of a Chebyshev expansion with coefficients ck</span>
<span class="sd">    returns the coefficients of the derivative in the Chebyshev basis</span>
<span class="sd">    assumes ck computed for r in the domain [ricb,rcmb] (if ricb&gt;0)</span>
<span class="sd">    or r in [-rcmb,rcmb] if ricb=0.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
    <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">s</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>  <span class="c1">#,dtype=np.complex128)</span>
    <span class="n">out</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="mf">1.</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">s</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ck</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span>

    <span class="k">if</span> <span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="n">out</span><span class="o">/</span><span class="n">rcmb</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">out1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">out</span><span class="o">/</span><span class="p">(</span><span class="n">rcmb</span><span class="o">-</span><span class="n">ricb</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out1</span></div>




<div class="viewcode-block" id="Dn_cheb">
<a class="viewcode-back" href="../utils.html#utils.Dn_cheb">[docs]</a>
<span class="k">def</span> <span class="nf">Dn_cheb</span><span class="p">(</span><span class="n">ck</span><span class="p">,</span> <span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">,</span> <span class="n">Dorder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the Chebyshev coefficients of the derivatives (up to order n)</span>
<span class="sd">    of a Chebyshev expansion with coefficients ck. Assumes ck is computed</span>
<span class="sd">    for r in the domain [ricb,rcmb] (if ricb&gt;0) or r in [-rcmb,rcmb] if ricb=0.</span>
<span class="sd">    First column correspond to the first derivative, last column to the</span>
<span class="sd">    n-th derivative.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">s</span><span class="p">,</span><span class="n">Dorder</span><span class="p">),</span> <span class="n">ck</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dcheb</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Dorder</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[:,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dcheb</span><span class="p">(</span> <span class="n">out</span><span class="p">[:,</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="chebify">
<a class="viewcode-back" href="../utils.html#utils.chebify">[docs]</a>
<span class="k">def</span> <span class="nf">chebify</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">Dorder</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the Chebyshev coeffs of function func,</span>
<span class="sd">    and its derivatives (as columns) up to order Dorder.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">c0</span> <span class="o">=</span> <span class="n">chebco_rf</span><span class="p">(</span> <span class="n">func</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span> <span class="n">c0</span><span class="p">,</span> <span class="n">Dn_cheb</span><span class="p">(</span><span class="n">c0</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">,</span> <span class="n">Dorder</span><span class="p">)</span> <span class="p">]</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="cheb3Product">
<a class="viewcode-back" href="../utils.html#utils.cheb3Product">[docs]</a>
<span class="k">def</span> <span class="nf">cheb3Product</span><span class="p">(</span><span class="n">ck1</span><span class="p">,</span> <span class="n">ck2</span><span class="p">,</span> <span class="n">ck3</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes the product of three Chebyshev series</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">Mlam</span><span class="p">(</span><span class="n">ck1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">Mlam</span><span class="p">(</span><span class="n">ck2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">ck3</span> <span class="p">)</span>
    <span class="n">out</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="cheb2Product">
<a class="viewcode-back" href="../utils.html#utils.cheb2Product">[docs]</a>
<span class="k">def</span> <span class="nf">cheb2Product</span><span class="p">(</span><span class="n">ck1</span><span class="p">,</span> <span class="n">ck2</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes the product of two Chebyshev series</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">Mlam</span><span class="p">(</span><span class="n">ck1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">ck2</span>
    <span class="n">out</span><span class="p">[</span> <span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span> <span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">out</span></div>





<div class="viewcode-block" id="get_radial_derivatives">
<a class="viewcode-back" href="../utils.html#utils.get_radial_derivatives">[docs]</a>
<span class="k">def</span> <span class="nf">get_radial_derivatives</span><span class="p">(</span> <span class="n">func</span><span class="p">,</span> <span class="n">rorder</span><span class="p">,</span> <span class="n">Dorder</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function computes terms of the form r^n d^m/dr^m of a</span>
<span class="sd">    radial profile in Chebyshev space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func   : function</span>
<span class="sd">        Radial profile in the form of a function (can be found in utils)</span>
<span class="sd">    rorder : integer</span>
<span class="sd">        Highest order of radial power</span>
<span class="sd">    Dorder : integer</span>
<span class="sd">        Highest order of radial derivative</span>
<span class="sd">    tol    : real</span>
<span class="sd">        Tolerance for Chebyshev transforms for radial powers</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    rd_prof : 2D list</span>
<span class="sd">        List such that rd_prof[i][j] defines the Chebyshev coefficients of</span>
<span class="sd">        r^i d^j/dr^j of the radial profile</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1"># Make sure these are integers</span>
    <span class="n">rorder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rorder</span><span class="p">)</span>
    <span class="n">Dorder</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">Dorder</span><span class="p">)</span>

    <span class="n">rd_prof</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Dorder</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rorder</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="c1">#List for Cheb coeffs to r^n D^m profile</span>
    <span class="n">dnprof</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Dorder</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="p">]</span> <span class="c1">#List for Cheb coeffs of nth derivative of profile</span>
    <span class="c1"># Cheb coeffs of profile</span>
    <span class="n">dnprof</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chebco_f</span><span class="p">(</span> <span class="n">func</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">tol_tc</span> <span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rorder</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">rn</span>  <span class="o">=</span> <span class="n">chebco</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="n">tol</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">)</span> <span class="c1">#Cheb coeffs of r^i</span>
        <span class="n">rd_prof</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="n">chebProduct</span><span class="p">(</span><span class="n">dnprof</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rn</span><span class="p">,</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">par</span><span class="o">.</span><span class="n">tol_tc</span><span class="p">)</span> <span class="c1">#Cheb coeffs of r^i profile</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Dorder</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="c1"># Cheb coeffs of r^i D^j profile</span>
            <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="c1"># These only need to be computed once</span>
                <span class="n">dnprof</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dcheb</span><span class="p">(</span><span class="n">dnprof</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">,</span><span class="n">rcmb</span><span class="p">)</span>
            <span class="n">rd_prof</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">chebProduct</span><span class="p">(</span><span class="n">dnprof</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">rn</span><span class="p">,</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">,</span><span class="n">par</span><span class="o">.</span><span class="n">tol_tc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rd_prof</span></div>




<div class="viewcode-block" id="jl_smx">
<a class="viewcode-back" href="../utils.html#utils.jl_smx">[docs]</a>
<span class="k">def</span> <span class="nf">jl_smx</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Spherical Bessel function of the first kind and derivatives,</span>
<span class="sd">    small argument (x&lt;&lt;1) only, 0 &lt;= d &lt;= 3</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">c1</span> <span class="o">=</span>  <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="n">scsp</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">l</span><span class="p">)</span><span class="o">/</span><span class="n">scsp</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="n">scsp</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">scsp</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">c3</span> <span class="o">=</span>  <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="n">scsp</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">scsp</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">5</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">c1</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="n">l</span> <span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">c1</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">c1</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="n">l</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">l</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="n">l</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l</span><span class="o">&gt;=</span><span class="mi">3</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">c1</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">c2</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">c3</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="jl">
<a class="viewcode-back" href="../utils.html#utils.jl">[docs]</a>
<span class="k">def</span> <span class="nf">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Spherical Bessel function of the first kind</span>
<span class="sd">    d is zero or 1</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

    <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="o">&lt;</span><span class="mf">1e-3</span>
    <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>  <span class="o">=</span> <span class="n">jl_smx</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="n">d</span><span class="p">)</span>
    <span class="n">out</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">scsp</span><span class="o">.</span><span class="n">spherical_jn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">],</span><span class="n">derivative</span><span class="o">=</span><span class="n">d</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="nl">
<a class="viewcode-back" href="../utils.html#utils.nl">[docs]</a>
<span class="k">def</span> <span class="nf">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">d</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Spherical Bessel function of the second kind</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">scsp</span><span class="o">.</span><span class="n">spherical_yn</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">derivative</span><span class="o">=</span><span class="n">d</span><span class="p">)</span></div>




<div class="viewcode-block" id="dlogjl">
<a class="viewcode-back" href="../utils.html#utils.dlogjl">[docs]</a>
<span class="k">def</span> <span class="nf">dlogjl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Log derivative of spherical Bessel function of the first kind</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># functional form of the numerator and denominator in the continued fraction</span>
    <span class="k">def</span> <span class="nf">num</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">def</span> <span class="nf">denom</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">x</span>

    <span class="c1"># Lentz-Thompson algorithm</span>
    <span class="k">def</span> <span class="nf">lentz_thompson</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-15</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mf">1e-12</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">b0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="n">eps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f0</span> <span class="o">=</span> <span class="n">b0</span>
        <span class="n">c0</span> <span class="o">=</span> <span class="n">f0</span><span class="p">;</span><span class="n">d0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">c0</span><span class="p">;</span><span class="n">d</span> <span class="o">=</span> <span class="n">d0</span><span class="p">;</span><span class="n">f</span> <span class="o">=</span> <span class="n">f0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span> <span class="n">c</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">eps</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span>
            <span class="k">if</span> <span class="n">d</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">d</span> <span class="o">=</span> <span class="n">eps</span>
            <span class="n">d</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">d</span>
            <span class="n">Delta</span> <span class="o">=</span> <span class="n">c</span> <span class="o">*</span> <span class="n">d</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="n">Delta</span>
            <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">Delta</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">acc</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="c1"># first 100 numerators and denominators in continued fraction</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">num</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="o">+</span><span class="mi">101</span><span class="p">)]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">denom</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">l</span><span class="o">+</span><span class="mi">101</span><span class="p">)]</span>

    <span class="c1"># first term in the sum (in front of first quotient)</span>
    <span class="n">b0</span> <span class="o">=</span> <span class="n">l</span> <span class="o">/</span> <span class="n">x</span>

    <span class="k">return</span> <span class="n">lentz_thompson</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">b0</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-30</span><span class="p">,</span> <span class="n">acc</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">)</span></div>




<div class="viewcode-block" id="findbeta">
<a class="viewcode-back" href="../utils.html#utils.findbeta">[docs]</a>
<span class="k">def</span> <span class="nf">findbeta</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    root finding for beta, needed for the Free Decay Modes</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">beta0</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ell</span>   <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ricb</span>  <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">f0</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">ric</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ric</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Zhang &amp; Fearn, GAFD (1995), page 196.</span>
            <span class="k">return</span> <span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">*</span><span class="n">ric</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="o">*</span><span class="n">ric</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ric</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Gubbins &amp; Roberts (1987), page 49.</span>
            <span class="k">return</span> <span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">sol</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">root</span><span class="p">(</span> <span class="n">f0</span><span class="p">,</span> <span class="n">beta0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ricb</span><span class="p">,</span> <span class="n">ell</span><span class="p">)</span> <span class="p">)</span>
    <span class="n">beta1</span> <span class="o">=</span> <span class="n">sol</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">beta1</span></div>

<span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">B0</span> <span class="o">==</span> <span class="s1">&#39;FDM&#39;</span><span class="p">:</span>
    <span class="n">beta_actual</span> <span class="o">=</span> <span class="n">findbeta</span><span class="p">([</span><span class="n">par</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">B0_l</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">])</span>



<div class="viewcode-block" id="h0">
<a class="viewcode-back" href="../utils.html#utils.h0">[docs]</a>
<span class="k">def</span> <span class="nf">h0</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Radial poloidal function for the background magnetic field times</span>
<span class="sd">    a power of r</span>
<span class="sd">    args[0] = guess for beta (FDM, radial complexity)</span>
<span class="sd">    args[1] = order l (FDM, l=1 is dipole)</span>
<span class="sd">    args[2] = ricb</span>
<span class="sd">    args[3] = power of r</span>

<span class="sd">    If extending to r&lt;0 then this function has parity (-1)**(l+rp)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">b</span>    <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">l</span>    <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ricb</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">rp</span>   <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span>   <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;axial&#39;</span><span class="p">:</span>       <span class="c1"># axial uniform field in the z direction</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;dipole&#39;</span> <span class="ow">and</span> <span class="n">ricb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>      <span class="c1"># dipole, singular at r=0</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;G21 dipole&#39;</span><span class="p">:</span>  <span class="c1"># Felix&#39;s dipole (Gerick 2021)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">3</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;Luo_S1&#39;</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;Luo_S2&#39;</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">157</span><span class="o">-</span><span class="mi">296</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="mi">143</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;FDM&#39;</span><span class="p">:</span>         <span class="c1"># poloidal Free Decay Mode</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">findbeta</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">r</span>

        <span class="k">if</span> <span class="n">ricb</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Gubbins &amp; Roberts (1987), page 49, eq. 3.67</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Zhang &amp; Fearn, GAFD (1995), page 196, eq. 2.7</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span> <span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span>

    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="n">out2</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">out2</span><span class="p">[</span><span class="n">rr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out2</span></div>




<div class="viewcode-block" id="h1">
<a class="viewcode-back" href="../utils.html#utils.h1">[docs]</a>
<span class="k">def</span> <span class="nf">h1</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    First radial derivative of the function h0, times a power of r</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">b</span>    <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">l</span>    <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ricb</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">rp</span>   <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;axial&#39;</span><span class="p">:</span>         <span class="c1"># axial uniform field in the z direction</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;dipole&#39;</span> <span class="ow">and</span> <span class="n">ricb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>      <span class="c1"># dipole, singular at r=0</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;G21 dipole&#39;</span><span class="p">:</span>  <span class="c1"># Felix&#39;s dipole (Gerick 2021)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">6</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span> <span class="o">-</span> <span class="p">(</span><span class="mi">3</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">2</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;Luo_S1&#39;</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span> <span class="o">-</span> <span class="mi">9</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;Luo_S2&#39;</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">out</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rp</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">157</span> <span class="o">-</span> <span class="mi">592</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">429</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;FDM&#39;</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">findbeta</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">r</span>
        <span class="k">if</span> <span class="n">ricb</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="p">(</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> <span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span>

    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="n">out2</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">out2</span><span class="p">[</span><span class="n">rr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out2</span></div>




<div class="viewcode-block" id="h2">
<a class="viewcode-back" href="../utils.html#utils.h2">[docs]</a>
<span class="k">def</span> <span class="nf">h2</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Second radial derivative of the function h0, times a power of r</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">b</span>    <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">l</span>    <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ricb</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">rp</span>   <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;axial&#39;</span><span class="p">:</span>         <span class="c1"># axial uniform field in the z direction</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;dipole&#39;</span> <span class="ow">and</span> <span class="n">ricb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>      <span class="c1"># dipole, singular at r=0</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;G21 dipole&#39;</span><span class="p">:</span>  <span class="c1"># Felix&#39;s dipole (Gerick 2021)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;Luo_S1&#39;</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">18</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;Luo_S2&#39;</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">out</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span><span class="o">*</span><span class="p">(</span><span class="mi">157</span> <span class="o">-</span> <span class="mi">1776</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2145</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;FDM&#39;</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">findbeta</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">r</span>
        <span class="k">if</span> <span class="n">ricb</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="o">&lt;</span><span class="mf">1e-3</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">out</span><span class="p">[</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl_smx</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="n">rp</span>
            <span class="n">out</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">],</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="n">rp</span> <span class="o">+</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">],</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">],</span><span class="mi">1</span><span class="p">)))</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">out</span><span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">x</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> \
             <span class="o">-</span> <span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="mi">1</span><span class="p">))))</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="n">out2</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">out2</span><span class="p">[</span><span class="n">rr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out2</span></div>




<div class="viewcode-block" id="h3">
<a class="viewcode-back" href="../utils.html#utils.h3">[docs]</a>
<span class="k">def</span> <span class="nf">h3</span><span class="p">(</span><span class="n">rr</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Third radial derivative of the function h0, times a power of r</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">b</span>    <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">l</span>    <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ricb</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">rp</span>   <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;axial&#39;</span><span class="p">:</span>         <span class="c1"># axial uniform field in the z direction</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;dipole&#39;</span> <span class="ow">and</span> <span class="n">ricb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>      <span class="c1"># dipole, singular at r=0</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">12</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;G21 dipole&#39;</span><span class="p">:</span>  <span class="c1"># Felix&#39;s dipole (Gerick 2021)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span><span class="o">/</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;Luo_S1&#39;</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">18</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="n">rp</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;Luo_S2&#39;</span><span class="p">:</span>
        <span class="n">l</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">out</span> <span class="o">=</span> <span class="mi">24</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">rp</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">296</span> <span class="o">+</span> <span class="mi">715</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;FDM&#39;</span><span class="p">:</span>

        <span class="n">b</span> <span class="o">=</span> <span class="n">findbeta</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">r</span>

        <span class="k">if</span> <span class="n">l</span><span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">ricb</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

                <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="o">&lt;</span><span class="mf">1e-3</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span> <span class="n">k</span><span class="p">]</span>  <span class="c1"># small x</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span>  <span class="c1"># the rest</span>

                <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">jl_smx</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="n">rp</span>

                <span class="n">out</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x1</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">l</span><span class="o">*</span><span class="n">x1</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">x1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> \
                 <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">x1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> \
                 <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">x1</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">x1</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">x1</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">out</span> <span class="o">=</span> <span class="p">((</span><span class="n">b</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> \
                 <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> \
                 <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">jl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span> \
                 <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> \
                 <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">3</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">l</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)))</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">l</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">ricb</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>

                <span class="n">k</span> <span class="o">=</span> <span class="n">x</span><span class="o">&lt;</span><span class="mf">1e-3</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span> <span class="n">k</span><span class="p">]</span>  <span class="c1"># small x</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span>  <span class="c1"># the rest</span>

                <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
                <span class="n">out</span><span class="p">[</span> <span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">jl_smx</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">x0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="n">rp</span>

                <span class="n">out</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">x1</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">x1</span><span class="o">*</span><span class="p">(</span><span class="mi">8</span> <span class="o">-</span> <span class="n">x1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="o">~</span><span class="n">k</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> \
                 <span class="o">-</span> <span class="n">b</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> \
                 <span class="o">-</span> <span class="mi">8</span><span class="o">*</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">jl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">nl</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">b</span><span class="o">*</span><span class="n">r</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">rr</span><span class="p">)</span>
    <span class="n">out2</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">rr</span><span class="p">[</span><span class="n">rr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">])):</span>
        <span class="n">out2</span><span class="p">[</span><span class="n">rr</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flipud</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">rp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out2</span></div>




<div class="viewcode-block" id="chebco_h">
<a class="viewcode-back" href="../utils.html#utils.chebco_h">[docs]</a>
<span class="k">def</span> <span class="nf">chebco_h</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes the Chebyshev coeffs of the h0 function used to build B0,</span>
<span class="sd">    and derivatives, times a power of r.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="c1">#beta = args[0]  # beta</span>
    <span class="c1">#l    = args[1]  # l</span>
    <span class="n">ricb</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># ricb</span>
    <span class="c1">#rx   = args[3]  # power of r</span>

    <span class="n">dx</span>   <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>  <span class="c1"># derivative order</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ricb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="p">(</span><span class="n">ricb</span> <span class="o">+</span> <span class="p">(</span><span class="n">rcmb</span> <span class="o">-</span> <span class="n">ricb</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">ri</span> <span class="o">=</span> <span class="n">rcmb</span> <span class="o">*</span> <span class="n">xi</span>

    <span class="k">if</span>   <span class="n">dx</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="n">h0</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">dx</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">:</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="n">h1</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">dx</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">:</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="n">h2</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">dx</span> <span class="o">==</span> <span class="mi">3</span> <span class="p">:</span>
        <span class="n">fi</span> <span class="o">=</span> <span class="n">h3</span><span class="p">(</span><span class="n">ri</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">[:</span><span class="mi">4</span><span class="p">])</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">sft</span><span class="o">.</span><span class="n">dct</span><span class="p">(</span><span class="n">fi</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
    <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="B0_norm">
<a class="viewcode-back" href="../utils.html#utils.B0_norm">[docs]</a>
<span class="k">def</span> <span class="nf">B0_norm</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the normalization constant of the applied magnetic field</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">magnetic</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

        <span class="n">ricb</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span> <span class="n">par</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">B0_l</span><span class="p">,</span> <span class="n">ricb</span><span class="p">,</span> <span class="mi">0</span> <span class="p">]</span>
        <span class="n">kind</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">B0</span>

        <span class="n">l</span> <span class="o">=</span> <span class="n">B0_l</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">cnorm</span> <span class="o">==</span> <span class="s1">&#39;rms_cmb&#39;</span><span class="p">:</span>  <span class="c1"># rms of radial magnetic field at the cmb is set to 1</span>

            <span class="n">rk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="n">l</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">h0</span><span class="p">(</span><span class="n">rk</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">par</span><span class="o">.</span><span class="n">cnorm</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mag_energy&#39;</span><span class="p">,</span> <span class="s1">&#39;Schmitt2012&#39;</span><span class="p">]:</span>  <span class="c1"># total magnetic energy is set to 1 or 2</span>

            <span class="n">N</span> <span class="o">=</span> <span class="mi">240</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
            <span class="n">xk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span> <span class="p">)</span>  <span class="c1"># colocation points, from -1 to 1</span>
            <span class="n">sqx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xk</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">rk</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ricb</span><span class="p">)</span><span class="o">*</span><span class="p">(</span> <span class="n">xk</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">)</span> <span class="o">+</span> <span class="n">ricb</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rk</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">y0</span> <span class="o">=</span> <span class="n">h0</span><span class="p">(</span><span class="n">rk</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="n">h1</span><span class="p">(</span><span class="n">rk</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

            <span class="n">f0</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">L</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">f1</span> <span class="o">=</span> <span class="p">(</span><span class="n">L</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">y0</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">f2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">rk</span><span class="o">*</span><span class="n">y0</span><span class="o">*</span><span class="n">y1</span>
            <span class="n">f3</span> <span class="o">=</span> <span class="n">r2</span><span class="o">*</span><span class="n">y1</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">integ</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ricb</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span> <span class="n">sqx</span><span class="o">*</span><span class="n">f0</span><span class="o">*</span><span class="p">(</span> <span class="n">f1</span><span class="o">+</span><span class="n">f2</span><span class="o">+</span><span class="n">f3</span> <span class="p">)</span> <span class="p">)</span>

            <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">cnorm</span> <span class="o">==</span> <span class="s1">&#39;mag_energy&#39;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">integ</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">par</span><span class="o">.</span><span class="n">cnorm</span> <span class="o">==</span> <span class="s1">&#39;Schmitt2012&#39;</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="mi">2</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">integ</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">out</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">cnorm</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="Dlam">
<a class="viewcode-back" href="../utils.html#utils.Dlam">[docs]</a>
<span class="k">def</span> <span class="nf">Dlam</span><span class="p">(</span><span class="n">derivative_order</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
         <span class="n">truncation_order</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">ss</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Returns the :math:`\\mathbf{\\mathcal D}_\\lambda` matrix of derivatives in Gegenbauer space. Direct</span>
<span class="sd">    implementation of its definition in Olver and Townsend (2013). The final if-else clause takes care of the fact</span>
<span class="sd">    that Gegenbauer polynomials are evaluated at a coordinate x that is a function of r, and therefore the chain rule needs to be applied.</span>

<span class="sd">    :param derivative_order: The order :math:`\\lambda` of the derivative.</span>
<span class="sd">    :param truncation_order: The maximum order of the expansion of the result. Sets the size of the operator.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">truncation_order</span> <span class="o">=</span> <span class="n">truncation_order</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># This line is here because I (Jorge) use &quot;truncation order&quot; to mean something slightly different from what the code means by &quot;N&quot;.</span>

    <span class="k">if</span> <span class="n">derivative_order</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;(derivative_operator): Negative derivative order. Invalid.&#39;</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">derivative_order</span> <span class="o">&gt;</span> <span class="n">truncation_order</span><span class="p">:</span>
        <span class="n">warn</span><span class="p">(</span><span class="s1">&#39;(derivative_operator): Derivative order higher than truncation order. Result is the zero array.&#39;</span><span class="p">)</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">truncation_order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">truncation_order</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">derivative_order</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">truncation_order</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">diagonal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">derivative_order</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="n">ss</span><span class="o">.</span><span class="n">diags</span><span class="p">(</span><span class="n">diagonal</span><span class="p">,</span> <span class="n">offsets</span><span class="o">=</span><span class="n">derivative_order</span><span class="p">)</span><span class="o">.</span><span class="n">A</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">**</span> <span class="p">(</span><span class="n">derivative_order</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scsp</span><span class="o">.</span><span class="n">factorial</span><span class="p">(</span><span class="n">derivative_order</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">to_return</span>

    <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="n">to_return</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">rcmb</span><span class="p">)</span><span class="o">**</span><span class="n">derivative_order</span>  <span class="c1"># ok when rcmb is not 1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="n">to_return</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="n">rcmb</span><span class="o">-</span><span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">))</span><span class="o">**</span><span class="n">derivative_order</span>

    <span class="k">return</span> <span class="n">ss</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">to_return</span><span class="p">)</span></div>




<div class="viewcode-block" id="Slam">
<a class="viewcode-back" href="../utils.html#utils.Slam">[docs]</a>
<span class="k">def</span> <span class="nf">Slam</span><span class="p">(</span><span class="n">basis_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
         <span class="n">truncation_order</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">ss</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Direct implementation of :math:`\\mathbf{\\mathcal{S}}_\\lambda` from Olver and Townsend (2013). Pre-multiplies a</span>
<span class="sd">    vector of coefficients of a function in the :math:`C^{(\\lambda)}` and returns the vector of coefficients in the</span>
<span class="sd">    :math:`C^{(\\lambda+1)}` basis.</span>

<span class="sd">    :param basis_index: The Gegenbauer family index :math;`\\lambda`.</span>
<span class="sd">    :param truncation_order: The maximum order of the expansion of the result. Sets the size of the operator.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">truncation_order</span> <span class="o">=</span> <span class="n">truncation_order</span> <span class="o">-</span> <span class="mi">1</span> <span class="c1"># This line is here because I (Jorge) use &quot;truncation order&quot; to mean something slightly different from what the code means by &quot;N&quot;.</span>

    <span class="k">if</span> <span class="n">basis_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;(rotation_operator): Negative basis order. Invalid.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">basis_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">diagonal0</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">diagonal0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">diagonal2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">truncation_order</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">diagonal0</span> <span class="o">=</span> <span class="n">basis_index</span> <span class="o">/</span> <span class="p">(</span><span class="n">basis_index</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="n">diagonal2</span> <span class="o">=</span> <span class="o">-</span><span class="n">basis_index</span> <span class="o">/</span> <span class="p">(</span><span class="n">basis_index</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">ss</span><span class="o">.</span><span class="n">diags</span><span class="p">([</span><span class="n">diagonal0</span><span class="p">,</span> <span class="n">diagonal2</span><span class="p">],</span> <span class="n">offsets</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;csr&#39;</span><span class="p">)</span></div>




<div class="viewcode-block" id="starting_multiplication_coefficient">
<a class="viewcode-back" href="../utils.html#utils.starting_multiplication_coefficient">[docs]</a>
<span class="k">def</span> <span class="nf">starting_multiplication_coefficient</span><span class="p">(</span><span class="n">basis_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                        <span class="n">subindex</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                        <span class="n">idx1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                        <span class="n">idx2</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes the starting :math:`c_s^\\lambda(j,k)` coefficient for the matrix operator entry. This is the direct</span>
<span class="sd">    implementation of Eq.(3.9) from Olver and Townsend (2013). Note that what is called :math:`j` in this function</span>
<span class="sd">    according to the definition of :math:`c_s^\\lambda(j,k)` corresponds to the **column** of the matrix,</span>
<span class="sd">    confusingly denoted :math:`k` outside of this function</span>

<span class="sd">    :param basis_index: The basis index, :math:`\\lambda`.</span>
<span class="sd">    :param subindex: The :math:`s` subindex.</span>
<span class="sd">    :param idx1: The :math:`j` index.</span>
<span class="sd">    :param idx2: The :math:`k` index.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">to_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx1</span> <span class="o">+</span> <span class="n">idx2</span> <span class="o">+</span> <span class="n">basis_index</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">subindex</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">idx1</span> <span class="o">+</span> <span class="n">idx2</span> <span class="o">+</span> <span class="n">basis_index</span> <span class="o">-</span> <span class="n">subindex</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">subindex</span><span class="p">):</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="n">to_return</span> <span class="o">*</span> <span class="p">(</span><span class="n">basis_index</span><span class="o">+</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="n">to_return</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">basis_index</span><span class="o">+</span><span class="n">idx1</span><span class="o">+</span><span class="n">idx2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">subindex</span><span class="o">+</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">basis_index</span><span class="o">+</span><span class="n">idx1</span><span class="o">+</span><span class="n">idx2</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">subindex</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">idx1</span><span class="o">-</span><span class="n">subindex</span><span class="p">):</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="n">to_return</span> <span class="o">*</span> <span class="p">(</span><span class="n">basis_index</span><span class="o">+</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>
        <span class="n">to_return</span> <span class="o">=</span> <span class="n">to_return</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx2</span><span class="o">-</span><span class="n">subindex</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">idx2</span><span class="o">-</span><span class="n">subindex</span><span class="o">+</span><span class="n">basis_index</span><span class="o">+</span><span class="n">t</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">to_return</span></div>




<div class="viewcode-block" id="multiplication_coefficients">
<a class="viewcode-back" href="../utils.html#utils.multiplication_coefficients">[docs]</a>
<span class="k">def</span> <span class="nf">multiplication_coefficients</span><span class="p">(</span><span class="n">basis_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                <span class="n">range_of_subindex</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                <span class="n">idx1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                <span class="n">range_of_idx2</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes all the coefficients :math:`c_s^\\lambda(j,k)` for the matrix operator entry. This is the direct</span>
<span class="sd">    implementation of the recursion right below Eq.(3.9) from Olver and Townsend (2013). Note that what is called</span>
<span class="sd">    :math:`j` in this function according to the definition of :math:`c_s^\\lambda(j,k)` corresponds to the **column** of</span>
<span class="sd">    the matrix, confusingly denoted :math:`k` outside of this function</span>

<span class="sd">    :param basis_index: The basis index, :math:`\\lambda`.</span>
<span class="sd">    :param range_of_subindex: All :math:`s` involved in the sum.</span>
<span class="sd">    :param idx1: The :math:`j` involved in the sum</span>
<span class="sd">    :param range_of_idx2: All :math:`k` involved in the sum.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">to_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">range_of_subindex</span><span class="p">))</span>
    <span class="n">to_return</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">starting_multiplication_coefficient</span><span class="p">(</span><span class="n">basis_index</span><span class="p">,</span>
                                                       <span class="nb">int</span><span class="p">(</span><span class="n">range_of_subindex</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                       <span class="n">idx1</span><span class="p">,</span>
                                                       <span class="nb">int</span><span class="p">(</span><span class="n">range_of_idx2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_of_subindex</span><span class="p">)):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">range_of_subindex</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">idx2</span> <span class="o">=</span> <span class="n">range_of_idx2</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx1</span> <span class="o">+</span> <span class="n">idx2</span> <span class="o">+</span> <span class="n">basis_index</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">idx1</span> <span class="o">+</span> <span class="n">idx2</span> <span class="o">+</span> <span class="n">basis_index</span> <span class="o">-</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">basis_index</span> <span class="o">+</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx1</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">basis_index</span> <span class="o">+</span> <span class="n">idx1</span> <span class="o">-</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">basis_index</span> <span class="o">+</span> <span class="n">idx1</span> <span class="o">+</span> <span class="n">idx2</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">basis_index</span> <span class="o">+</span> <span class="n">idx1</span> <span class="o">+</span> <span class="n">idx2</span> <span class="o">-</span> <span class="n">s</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">idx2</span> <span class="o">-</span> <span class="n">s</span> <span class="o">+</span> <span class="n">basis_index</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">idx2</span> <span class="o">-</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">to_return</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">to_return</span><span class="p">[</span><span class="n">t</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">factor</span>

    <span class="k">return</span> <span class="n">to_return</span></div>




<div class="viewcode-block" id="Mlam">
<a class="viewcode-back" href="../utils.html#utils.Mlam">[docs]</a>
<span class="k">def</span> <span class="nf">Mlam</span><span class="p">(</span><span class="n">coefficients</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
         <span class="n">basis_index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
         <span class="n">vector_parity</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
         <span class="n">truncation_order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="o">|</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">|</span><span class="n">ss</span><span class="o">.</span><span class="n">csr_array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This function computes the :math:`\\mathcal{\\mathbf{M}}_\\lambda` operator, as described by Olver and Townsend (</span>
<span class="sd">    2013).</span>

<span class="sd">    - If :math:`\\lambda = 0`, the operator reduces to a Toeplitz + almost Hankel operators. This is the direct implementation of the equation right below Eq.(2.7) of Olver and Townsend (2013).</span>
<span class="sd">    - If :math:`\\lambda = 1`, the operator reduces to a Toeplitz + Hankel operators. However, it can be also be written as the sum of Toeplitz operators, each one adding to the previous outside of the first row and column. This is what has been done in this implementation.</span>
<span class="sd">    - Otherwise, each term in the operator is given by the expression between Eq.(3.7) and Eq.(3.8) of Olver and Townsend (2013).</span>

<span class="sd">    The present implementation also considers the parity of all elements. In the application of interest,</span>
<span class="sd">    this operator will be pre-multiplying the :math:`\\lambda`-th derivative of an eigenvector, so the parity of (a)</span>
<span class="sd">    the eigenvector itself, (b) the derivative and (c) the function represented in this multiplication operator are</span>
<span class="sd">    all taken into account to set certain rows and columns to zero.</span>

<span class="sd">    In the cases for :math:`\\lambda = 0,1`, this has been done by creating the full operators with the Scipy</span>
<span class="sd">    Toeplitz and Hankel functions, and then setting the appropriate rows and columns to 0. In the general case,</span>
<span class="sd">    where the operator is to be filled element by element, the useful elements have been identified at the begining</span>
<span class="sd">    and only those have been computed, skipping all the rest.</span>

<span class="sd">    :param basis_index: The index of the Gegenbauer family, :math:`\\lambda`.</span>
<span class="sd">    :param coefficients: The :math:`\\lambda`-th Gegenabuer coefficients of the factor represented in</span>
<span class="sd">    :math:`\\mathbf{\\mnathcal{M}[a]}, :math:`a_k`.</span>
<span class="sd">    :param vector_parity: The parity of the eigenvector.</span>
<span class="sd">    :param truncation_order: The truncation order, setting the size of the operator. If ``None``, it infers the order</span>
<span class="sd">    from the size of ``coefficients``. Defaults to None.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">basis_index</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;(multiplication_operator): Negative basis order. Invalid.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vector_parity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;(multiplication_operator): Invalid vector parity. Only allowed is 0, 1 or -1. Got &#39;</span>
                         <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">vector_parity</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">truncation_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">truncation_order</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span> <span class="c1"># There are no issues with &quot;truncation order vs. N&quot; here because it is all</span>
        <span class="c1"># handled internally and there is no interfacing with the outside.</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">coefficients</span><span class="p">))</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>

        <span class="n">to_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">truncation_order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">truncation_order</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># The parities of all individual elements. The parity of the factor represented in this multiplication</span>
        <span class="c1"># operator is assessed using (the parity of) its last non-zero coefficient.</span>
        <span class="n">last_nonzero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">derivative_parity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">basis_index</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">function_parity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">last_nonzero</span> <span class="o">%</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">operator_parity</span> <span class="o">=</span> <span class="n">vector_parity</span> <span class="o">*</span> <span class="n">derivative_parity</span> <span class="o">*</span> <span class="n">function_parity</span>

        <span class="k">if</span> <span class="n">basis_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="c1"># Auxiliary padding. Always good to have enough zeros in case they are needed.</span>
            <span class="n">coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)))</span>

            <span class="c1"># Toeplitz matrix</span>
            <span class="n">rowcol</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[:</span><span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">rowcol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">rowcol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">toeplitz</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">toeplitz</span><span class="p">(</span><span class="n">rowcol</span><span class="p">)</span>

            <span class="c1"># Hankel matrix</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[:</span><span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[</span><span class="n">truncation_order</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
            <span class="n">hankel</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">hankel</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="n">hankel</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">to_return</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">toeplitz</span> <span class="o">+</span> <span class="n">hankel</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">basis_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

            <span class="c1"># Auxiliary padding. Always good to have enough zeros in case they are needed.</span>
            <span class="n">coefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">coefficients</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)))</span>
            <span class="n">to_return</span> <span class="o">=</span> <span class="n">las</span><span class="o">.</span><span class="n">toeplitz</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[:</span><span class="n">truncation_order</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">truncation_order</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">to_return</span><span class="p">[</span><span class="n">idx</span><span class="p">:,</span><span class="n">idx</span><span class="p">:]</span> <span class="o">=</span> <span class="n">to_return</span><span class="p">[</span><span class="n">idx</span><span class="p">:,</span><span class="n">idx</span><span class="p">:]</span> <span class="o">+</span> <span class="n">las</span><span class="o">.</span><span class="n">toeplitz</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">idx</span><span class="p">:</span><span class="n">truncation_order</span><span class="o">+</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># In the general case, parity is taken care of at the very beginning.</span>
            <span class="k">if</span> <span class="n">vector_parity</span> <span class="o">*</span> <span class="n">derivative_parity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">column_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">vector_parity</span> <span class="o">*</span> <span class="n">derivative_parity</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">column_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">column_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">operator_parity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">row_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">vector_parity</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">row_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">row_range</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

            <span class="n">coefficients</span> <span class="o">=</span> <span class="n">coefficients</span><span class="p">[:</span><span class="n">last_nonzero</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># Now we loop over all useful entries of the operator.</span>
            <span class="n">to_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">truncation_order</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">truncation_order</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">row_range</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">column_range</span><span class="p">:</span>

                    <span class="c1"># Range of s as defined by Olver and Townsend (2013). Between Eq.(3.7) and Eq.(3.8).</span>
                    <span class="n">range_of_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">col</span><span class="o">-</span><span class="n">row</span><span class="p">),</span><span class="n">col</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">range_of_p</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">range_of_s</span> <span class="o">+</span> <span class="n">row</span> <span class="o">-</span> <span class="n">col</span>
                    <span class="c1"># The range of those indices are truncated according to the maximum &quot;significant&quot; order of the</span>
                    <span class="c1"># provided factor coefficients.</span>
                    <span class="n">range_of_s</span> <span class="o">=</span> <span class="n">range_of_s</span><span class="p">[</span><span class="n">range_of_p</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)]</span>
                    <span class="n">range_of_p</span> <span class="o">=</span> <span class="n">range_of_p</span><span class="p">[</span><span class="n">range_of_p</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">coefficients</span><span class="p">)]</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">range_of_s</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">to_return</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">array_of_multiplication_coefficients</span> <span class="o">=</span> <span class="n">multiplication_coefficients</span><span class="p">(</span><span class="n">basis_index</span><span class="p">,</span>
                                                                                           <span class="n">range_of_s</span><span class="p">,</span>
                                                                                           <span class="n">col</span><span class="p">,</span>
                                                                                           <span class="n">range_of_p</span><span class="p">)</span>

                        <span class="n">to_return</span><span class="p">[</span><span class="n">row</span><span class="p">,</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">coefficients</span><span class="p">[</span><span class="n">range_of_p</span><span class="p">]</span> <span class="o">*</span> <span class="n">array_of_multiplication_coefficients</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">basis_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">basis_index</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vector_parity</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>

            <span class="c1"># If the Toeplitz + Hankel simplifications were used, the parity is taken care of at the end by removing</span>
            <span class="c1"># all unnecessary rows/columns.</span>

            <span class="k">if</span> <span class="n">vector_parity</span> <span class="o">*</span> <span class="n">derivative_parity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">columns_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">columns_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">operator_parity</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">rows_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rows_to_remove</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

            <span class="n">to_return</span><span class="p">[</span><span class="n">rows_to_remove</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">rows_to_remove</span><span class="p">),</span> <span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">to_return</span><span class="p">[:,</span> <span class="n">columns_to_remove</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">truncation_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">columns_to_remove</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">ss</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">to_return</span><span class="p">)</span></div>




<div class="viewcode-block" id="chebProduct">
<a class="viewcode-back" href="../utils.html#utils.chebProduct">[docs]</a>
<span class="k">def</span> <span class="nf">chebProduct</span><span class="p">(</span><span class="n">ck</span><span class="p">,</span><span class="n">dk</span><span class="p">,</span><span class="n">tol</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Computes the Chebyshev expansion of a product of</span>
<span class="sd">    two Chebyshev series defined by ck and dk</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ck</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">Mlam</span><span class="p">(</span><span class="n">ck</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="n">dk</span>
    <span class="n">out</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="marc_tide">
<a class="viewcode-back" href="../utils.html#utils.marc_tide">[docs]</a>
<span class="k">def</span> <span class="nf">marc_tide</span><span class="p">(</span><span class="n">omega</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tidal body force as used by Rovira-Navarro et al, 2018</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">C0</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="p">;</span> <span class="n">C1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">C2</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span>

    <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;top&#39;</span><span class="p">:</span>
        <span class="n">r5</span> <span class="o">=</span> <span class="n">chebco</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mf">2e-16</span><span class="p">,</span> <span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="n">j</span><span class="o">*</span><span class="n">C0</span><span class="o">*</span><span class="n">omega</span><span class="o">*</span><span class="n">r5</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="n">j</span><span class="o">*</span><span class="n">C1</span><span class="o">*</span><span class="p">(</span><span class="n">omega</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">r5</span>
        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">6</span><span class="n">j</span><span class="o">*</span><span class="n">C2</span><span class="o">*</span><span class="p">(</span><span class="n">omega</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">r5</span>

    <span class="k">elif</span> <span class="n">loc</span> <span class="o">==</span> <span class="s1">&#39;bot&#39;</span><span class="p">:</span>
        <span class="n">r4</span> <span class="o">=</span> <span class="n">chebco</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">N</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mf">2e-16</span><span class="p">,</span> <span class="n">ricb</span><span class="p">,</span> <span class="n">rcmb</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">C0</span><span class="o">*</span><span class="n">r4</span>
            <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">24</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">C0</span><span class="o">*</span><span class="n">r4</span>

        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">C1</span><span class="o">*</span><span class="n">r4</span>
            <span class="k">elif</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">16</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">C1</span><span class="o">*</span><span class="n">r4</span>

        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">*</span><span class="n">C2</span><span class="o">*</span><span class="n">r4</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="eccen_tide">
<a class="viewcode-back" href="../utils.html#utils.eccen_tide">[docs]</a>
<span class="k">def</span> <span class="nf">eccen_tide</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">eta</span><span class="p">,</span> <span class="n">boundary</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Eccentricity tide as boundary forcing.</span>
<span class="sd">    Computed by Jeremy</span>
<span class="sd">    eta = ricb</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">boundary</span> <span class="o">==</span> <span class="s1">&#39;cmb&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>

            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.00927601455473e-7</span> <span class="o">+</span> <span class="mf">9.923006738722803e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">+</span> <span class="mf">2.0022902696912132e-6</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">+</span> <span class="mf">2.078150971132207e-6</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">0.9796806966104893</span> <span class="o">+</span> <span class="mf">10.138063592395676</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">22.793605369253733</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">49.52238501116611</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">dP</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.6923409583928235e-8</span> <span class="o">+</span> <span class="mf">5.525597059314317e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.491072486300637e-6</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">+</span> <span class="mf">1.7131360325476716e-6</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">0.990016066975477</span> <span class="o">+</span> <span class="mf">10.903688391808103</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">28.973467794986213</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">54.35051022571307</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0530272472650882e-7</span> <span class="o">-</span> <span class="mf">3.4723290320109935e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mf">7.006556396692487e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">-</span> <span class="mf">7.272013553918712e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">0.9796806966105374</span> <span class="o">+</span> <span class="mf">10.138063592396957</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">22.793605369262107</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">49.52238501117491</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">dP</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.2920501863486681e-8</span> <span class="o">-</span> <span class="mf">1.933556188506115e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mf">5.217666801343201e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">-</span> <span class="mf">5.994727342457128e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">0.990016066975396</span> <span class="o">+</span> <span class="mf">10.903688391807878</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">28.973467794991336</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">54.35051022572941</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">4.2989657350784934e-8</span> <span class="o">-</span> <span class="mf">1.4175723912463045e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.860414670987557e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">-</span> <span class="mf">2.9687871016172726e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">0.9796806966105591</span> <span class="o">+</span> <span class="mf">10.1380635923966</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">22.793605369256564</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">49.522385011165795</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">dP</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.274772797703058e-9</span> <span class="o">-</span> <span class="mf">7.893710084733917e-8</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.1301035518586083e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">-</span> <span class="mf">2.4473371893559314e-7</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">0.990016066975294</span> <span class="o">+</span> <span class="mf">10.903688391807277</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">28.973467794994058</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mf">54.35051022573984</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">boundary</span> <span class="o">==</span> <span class="s1">&#39;icb&#39;</span><span class="p">:</span>

        <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>

            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.450645275222846e-9</span> <span class="o">+</span> <span class="mf">1.6226580438374377e-8</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">+</span> <span class="mf">3.8162533600883e-8</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">+</span> <span class="mf">2.1621482543044536e-8</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0040474189168584</span> <span class="o">+</span> <span class="mf">9.816014125318514</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">12.467747302017761</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.13326826070343542</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">dP</span> <span class="o">=</span> <span class="p">(</span><span class="mf">5.690951704457902e-11</span> <span class="o">+</span> <span class="mf">6.365766130462465e-10</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.4971346844873185e-9</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">+</span> <span class="mf">8.482212366654875e-10</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0040474189168667</span> <span class="o">+</span> <span class="mf">9.816014125318599</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">12.467747302017914</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.13326826070340814</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.076201031536069e-10</span> <span class="o">-</span> <span class="mf">5.678120334892032e-9</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.3354104944854432e-8</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">-</span> <span class="mf">7.565942816136093e-9</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0040474189168602</span> <span class="o">+</span> <span class="mf">9.81601412531852</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">12.467747302017683</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.13326826070345546</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">dP</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.991418260963427e-11</span> <span class="o">-</span> <span class="mf">2.22755412021775e-10</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mf">5.238880076023669e-10</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">-</span> <span class="mf">2.96815602688989e-10</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0040474189168587</span> <span class="o">+</span> <span class="mf">9.816014125318501</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">12.46774730201766</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.13326826070345907</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>

            <span class="n">P</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.072350393175482e-10</span> <span class="o">-</span> <span class="mf">2.3180829197677505e-9</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mf">5.451790514411792e-9</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">-</span> <span class="mf">3.0887832204348696e-9</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0040474189168525</span> <span class="o">+</span> <span class="mf">9.816014125318436</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">12.46774730201756</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.13326826070347508</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

            <span class="n">dP</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">8.129931006368303e-12</span> <span class="o">-</span> <span class="mf">9.093951614946213e-11</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.138763834981828e-10</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> \
            <span class="o">-</span> <span class="mf">1.2117446238077878e-10</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0040474189168571</span> <span class="o">+</span> <span class="mf">9.816014125318477</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span> \
            <span class="o">+</span> <span class="mf">12.467747302017562</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">0.13326826070347858</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">0.8809523809523809</span> <span class="o">+</span> <span class="n">eta</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">P</span><span class="p">,</span><span class="n">dP</span><span class="p">])</span></div>




<div class="viewcode-block" id="ftest1">
<a class="viewcode-back" href="../utils.html#utils.ftest1">[docs]</a>
<span class="k">def</span> <span class="nf">ftest1</span><span class="p">(</span><span class="n">ricb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Tidal body force constants for Enceladus</span>
<span class="sd">    Computed by Jeremy</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.776146590187793e-8</span> <span class="o">-</span> <span class="mf">1.1936189474389837e-7</span><span class="o">*</span><span class="n">ricb</span> <span class="o">+</span> <span class="mf">1.7976942241610017e-7</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">1.0431683766634872e-7</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">3</span> \
    <span class="o">+</span> <span class="mf">1.0203567472726217e-8</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">4</span> <span class="o">+</span> <span class="mf">5.944217795551174e-9</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.039370654683117</span> <span class="o">-</span> <span class="mf">12.426922103588517</span><span class="o">*</span><span class="n">ricb</span> \
    <span class="o">+</span> <span class="mf">29.534185532382605</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">33.58608820683908</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mf">17.080450537622824</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mf">1.6409964140402016</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">5</span> <span class="o">-</span> <span class="mf">1.</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>

    <span class="n">B</span> <span class="o">=</span> <span class="p">(</span><span class="mf">7.525664633338715e-9</span> <span class="o">-</span> <span class="mf">5.8895735957722854e-8</span><span class="o">*</span><span class="n">ricb</span> <span class="o">+</span> <span class="mf">1.8268212761498169e-7</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">2.798206106175817e-7</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">3</span> \
    <span class="o">+</span> <span class="mf">2.1103777701038198e-7</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mf">6.252914009737955e-8</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">5</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.039370654683117</span> <span class="o">-</span> <span class="mf">12.426922103588517</span><span class="o">*</span><span class="n">ricb</span> \
    <span class="o">+</span> <span class="mf">29.534185532382605</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">33.58608820683908</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="mf">17.080450537622824</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="mf">1.6409964140402016</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">5</span> <span class="o">-</span> <span class="mf">1.</span><span class="o">*</span><span class="n">ricb</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>

    <span class="n">C</span> <span class="o">=</span> <span class="mf">1e6</span>

    <span class="c1">#A = 1.0</span>
    <span class="c1">#B = ricb**5</span>
    <span class="c1">#C = 1/(1-ricb**5)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="n">C</span><span class="p">])</span></div>




<span class="k">def</span> <span class="nf">Ylm</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
    <span class="c1"># The Spherical Harmonics, seminormalized</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">scsp</span><span class="o">.</span><span class="n">sph_harm</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">l</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>



<span class="k">def</span> <span class="nf">Ylm_full</span><span class="p">(</span><span class="n">lmax</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">):</span>
    <span class="c1"># array of Spherical Harmonics with a range of l&#39;s</span>
    <span class="n">m1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">m</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">lmax1</span> <span class="o">=</span> <span class="n">lmax</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">lmax1</span> <span class="o">=</span> <span class="n">lmax</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lmax</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m1</span><span class="p">,</span><span class="n">lmax1</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[</span><span class="n">l</span><span class="o">-</span><span class="n">m1</span><span class="p">]</span><span class="o">=</span><span class="n">Ylm</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">phi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>



<span class="k">def</span> <span class="nf">Ylm_symm</span><span class="p">(</span><span class="n">lmax</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">symm</span><span class="p">,</span> <span class="n">scalar</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">lmax</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex128</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">symm</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">scalar</span> <span class="o">==</span> <span class="s1">&#39;pol&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">symm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">scalar</span> <span class="o">==</span> <span class="s1">&#39;tor&#39;</span><span class="p">):</span>
        <span class="n">m_sym</span> <span class="o">=</span> <span class="n">m</span>
        <span class="n">lmax_sym</span> <span class="o">=</span> <span class="n">lmax</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">m_sym</span> <span class="o">=</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">lmax_sym</span> <span class="o">=</span> <span class="n">lmax</span><span class="o">+</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_sym</span><span class="p">,</span><span class="n">lmax_sym</span><span class="p">,</span><span class="mf">2.</span><span class="p">):</span>
        <span class="n">out</span><span class="p">[(</span><span class="n">l</span><span class="o">-</span><span class="n">m_sym</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">Ylm</span><span class="p">(</span><span class="n">l</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">theta</span><span class="p">,</span><span class="n">phi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>



<span class="k">def</span> <span class="nf">load_csr</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># utility to load sparse matrices efficiently</span>
    <span class="n">loader</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ss</span><span class="o">.</span><span class="n">csr_matrix</span><span class="p">((</span><span class="n">loader</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">loader</span><span class="p">[</span><span class="s1">&#39;indices&#39;</span><span class="p">],</span> <span class="n">loader</span><span class="p">[</span><span class="s1">&#39;indptr&#39;</span><span class="p">]),</span> <span class="n">shape</span><span class="o">=</span><span class="n">loader</span><span class="p">[</span><span class="s1">&#39;shape&#39;</span><span class="p">])</span>




<div class="viewcode-block" id="Tk">
<a class="viewcode-back" href="../utils.html#utils.Tk">[docs]</a>
<span class="k">def</span> <span class="nf">Tk</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">lamb_max</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Chebyshev polynomial from order 0 to N (as rows)</span>
<span class="sd">    and its derivatives ** with respect to r **, up to lamb_max (as columns),</span>
<span class="sd">    evaluated at x=-1 (r=ricb) or x=1 (r=rcmb).</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="n">ric</span> <span class="o">=</span> <span class="o">-</span><span class="n">rcmb</span>
    <span class="k">else</span> <span class="p">:</span>
        <span class="n">ric</span> <span class="o">=</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">lamb_max</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="n">k</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">lamb_max</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">*</span> <span class="p">(</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="p">)</span><span class="o">/</span><span class="p">(</span> <span class="mf">2.</span><span class="o">*</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.</span> <span class="p">)</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mf">1.</span><span class="p">)</span> <span class="o">*</span> <span class="n">tmp</span> <span class="o">*</span> <span class="p">(</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="n">rcmb</span><span class="o">-</span><span class="n">ric</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>




<span class="k">def</span> <span class="nf">gamma_visc</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span><span class="n">a2</span><span class="p">,</span><span class="n">a3</span><span class="p">):</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n0</span><span class="o">+</span><span class="n">n0</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>


    <span class="c1">#Tb3 = copy(Tb2)</span>
    <span class="c1">#Tb3[nc:,:] = 0</span>
    <span class="c1">#Tb3 = np.copy(bv.Tb)</span>
    <span class="n">Tb3</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>


    <span class="n">P0</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">P1</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">P2</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">P3</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">P4</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">P5</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span>

    <span class="n">T0</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">T1</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">T2</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">T3</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">T4</span> <span class="o">=</span> <span class="n">Tb3</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>


    <span class="c1"># this is for a spheroid with long semiaxis a=1</span>

    <span class="n">I</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span>

    <span class="n">pol2</span> <span class="o">=</span> <span class="p">(</span>  <span class="n">a1</span><span class="o">*</span><span class="p">((</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">24.624956739107787</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">24.624956739107787</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">12.312478369553894</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P2</span>
                <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">4.104159456517965</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">a2</span><span class="o">*</span><span class="p">((</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">5.2767764440945255</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">5.2767764440945255</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">2.6383882220472628</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P2</span>
                <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">9.67409014750663</span>  <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">1.758925481364842</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P4</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">a3</span><span class="o">*</span><span class="p">((</span><span class="mf">0.</span> <span class="o">-</span> <span class="mf">1.758925481364842</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">1.758925481364842</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">0.879462740682421</span>  <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P2</span>
                <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">0.2931542468941404</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">3.517850962729684</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P4</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">0.4885904114902339</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P5</span><span class="p">)</span> <span class="p">)</span>

    <span class="n">pol4</span> <span class="o">=</span> <span class="p">(</span>  <span class="n">a2</span><span class="o">*</span><span class="p">((</span><span class="mf">0.</span> <span class="o">-</span> <span class="mf">42.817918360629186</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">42.817918360629186</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">3.5681598633857656</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P2</span>
                <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">6.422687754094378</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">0.7136319726771531</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P4</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">a3</span><span class="o">*</span><span class="p">((</span><span class="mf">0.</span> <span class="o">-</span> <span class="mf">31.140304262275777</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">31.140304262275777</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">20.111446502719772</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P2</span>
                <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">2.465274087430165</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">3.6979111311452484</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P4</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">0.324378169398706</span>  <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P5</span><span class="p">))</span>

    <span class="n">pol6</span> <span class="o">=</span> <span class="p">(</span>  <span class="n">a3</span><span class="o">*</span><span class="p">((</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">45.56049760657571</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">45.56049760657571</span>  <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P1</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">22.780248803287854</span> <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P2</span>
                <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">3.254321257612551</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P3</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">1.30172850304502</span>   <span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P4</span> <span class="o">+</span> <span class="p">(</span><span class="mf">0.</span> <span class="o">+</span> <span class="mf">0.07231825016916779</span><span class="o">*</span><span class="n">I</span><span class="p">)</span><span class="o">*</span><span class="n">P5</span><span class="p">))</span>

    <span class="n">tol1</span> <span class="o">=</span> <span class="p">(</span> <span class="o">-</span><span class="mf">11.847687835088976</span>     <span class="o">*</span><span class="n">T0</span> <span class="o">+</span> <span class="mf">11.847687835088976</span><span class="o">*</span><span class="n">T1</span>
            <span class="o">+</span> <span class="n">a1</span><span class="o">*</span><span class="p">(</span><span class="mf">9.47815026807118</span>   <span class="o">*</span><span class="n">T0</span> <span class="o">-</span> <span class="mf">9.47815026807118</span>  <span class="o">*</span><span class="n">T1</span> <span class="o">-</span> <span class="mf">4.73907513403559</span>  <span class="o">*</span><span class="n">T2</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">a2</span><span class="o">*</span><span class="p">(</span><span class="mf">2.031032200300967</span>  <span class="o">*</span><span class="n">T0</span> <span class="o">-</span> <span class="mf">2.031032200300967</span> <span class="o">*</span><span class="n">T1</span> <span class="o">+</span> <span class="mf">5.077580500752418</span> <span class="o">*</span><span class="n">T2</span> <span class="o">+</span> <span class="mf">1.5232741502257257</span> <span class="o">*</span><span class="n">T3</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">a3</span><span class="o">*</span><span class="p">(</span><span class="mf">0.4513404889557705</span> <span class="o">*</span><span class="n">T0</span> <span class="o">-</span> <span class="mf">0.4513404889557705</span><span class="o">*</span><span class="n">T1</span> <span class="o">-</span> <span class="mf">1.8241678095295728</span><span class="o">*</span><span class="n">T3</span> <span class="o">-</span> <span class="mf">0.37611707412980877</span><span class="o">*</span><span class="n">T4</span><span class="p">))</span>

    <span class="n">tol3</span> <span class="o">=</span> <span class="p">(</span>  <span class="n">a1</span><span class="o">*</span><span class="p">(</span><span class="mf">39.799940335196546</span> <span class="o">*</span><span class="n">T0</span> <span class="o">-</span> <span class="mf">6.633323389199425</span> <span class="o">*</span><span class="n">T1</span> <span class="o">-</span> <span class="mf">3.3166616945997127</span><span class="o">*</span><span class="n">T2</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">a2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">19.899970167598273</span><span class="o">*</span><span class="n">T0</span> <span class="o">-</span> <span class="mf">13.26664677839885</span> <span class="o">*</span><span class="n">T1</span> <span class="o">+</span> <span class="mf">8.291654236499282</span> <span class="o">*</span><span class="n">T2</span> <span class="o">+</span> <span class="mf">1.6583308472998564</span> <span class="o">*</span><span class="n">T3</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">a3</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">14.472705576435107</span><span class="o">*</span><span class="n">T0</span> <span class="o">+</span> <span class="mf">7.93988708707204</span>  <span class="o">*</span><span class="n">T1</span> <span class="o">+</span> <span class="mf">2.010097996727099</span> <span class="o">*</span><span class="n">T2</span> <span class="o">-</span> <span class="mf">3.5679239441906003</span> <span class="o">*</span><span class="n">T3</span> <span class="o">-</span> <span class="mf">0.5025244991817748</span>  <span class="o">*</span><span class="n">T4</span><span class="p">))</span>

    <span class="n">tol5</span> <span class="o">=</span> <span class="p">(</span>  <span class="n">a2</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mf">57.208391908193846</span><span class="o">*</span><span class="n">T0</span> <span class="o">-</span> <span class="mf">9.534731984698974</span> <span class="o">*</span><span class="n">T1</span> <span class="o">+</span> <span class="mf">3.8138927938795897</span><span class="o">*</span><span class="n">T2</span> <span class="o">+</span> <span class="mf">0.4767365992349487</span> <span class="o">*</span><span class="n">T3</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">a3</span><span class="o">*</span><span class="p">(</span><span class="mf">4.400645531399526</span>  <span class="o">*</span><span class="n">T0</span> <span class="o">+</span> <span class="mf">34.960683943896235</span><span class="o">*</span><span class="n">T1</span> <span class="o">+</span> <span class="mf">0.6845448604399262</span><span class="o">*</span><span class="n">T2</span> <span class="o">-</span> <span class="mf">2.725955426394706</span>  <span class="o">*</span><span class="n">T3</span> <span class="o">-</span> <span class="mf">0.24448030729997366</span> <span class="o">*</span><span class="n">T4</span><span class="p">))</span>

    <span class="n">tol7</span> <span class="o">=</span> <span class="p">(</span>  <span class="n">a3</span><span class="o">*</span><span class="p">(</span><span class="mf">59.85704517989213</span>  <span class="o">*</span><span class="n">T0</span> <span class="o">+</span> <span class="mf">24.316924604331177</span><span class="o">*</span><span class="n">T1</span> <span class="o">-</span> <span class="mf">0.8016568550878411</span><span class="o">*</span><span class="n">T2</span> <span class="o">-</span> <span class="mf">0.7571203631385165</span> <span class="o">*</span><span class="n">T3</span> <span class="o">-</span> <span class="mf">0.044536491949324505</span><span class="o">*</span><span class="n">T4</span><span class="p">))</span>


    <span class="c1"># assemble the torque (row vector)</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_top</span><span class="p">,</span><span class="n">lmax_top</span><span class="p">,</span><span class="mf">2.</span><span class="p">):</span>

        <span class="n">colP</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">m_top</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">colP</span><span class="p">:</span><span class="n">colP</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">pol2</span>
        <span class="k">elif</span> <span class="n">l</span><span class="o">==</span><span class="mi">4</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">colP</span><span class="p">:</span><span class="n">colP</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">pol4</span>
        <span class="k">elif</span> <span class="n">l</span><span class="o">==</span><span class="mi">6</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">colP</span><span class="p">:</span><span class="n">colP</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">pol6</span>

    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">m_bot</span><span class="p">,</span><span class="n">lmax_bot</span><span class="p">,</span><span class="mf">2.</span><span class="p">):</span>

        <span class="n">colT</span> <span class="o">=</span> <span class="n">n0</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span> <span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">m_bot</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span>

        <span class="k">if</span> <span class="n">l</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">colT</span><span class="p">:</span><span class="n">colT</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">tol1</span>
        <span class="k">elif</span> <span class="n">l</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">colT</span><span class="p">:</span><span class="n">colT</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">tol3</span>
        <span class="k">elif</span> <span class="n">l</span><span class="o">==</span><span class="mi">5</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">colT</span><span class="p">:</span><span class="n">colT</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">tol5</span>
        <span class="k">elif</span> <span class="n">l</span><span class="o">==</span><span class="mi">7</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">colT</span><span class="p">:</span><span class="n">colT</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">tol7</span>

    <span class="c1"># axial torque for a spherical cmb, take 2*real after multiplying by the solution vector</span>
    <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">symm</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">R</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1">#rcmb</span>
        <span class="c1"># axial torque depends on the l=1, m=0 toroidal component only</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n0</span><span class="p">:</span><span class="n">n0</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span> <span class="n">R</span><span class="o">*</span><span class="n">T1</span> <span class="o">-</span> <span class="n">T0</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span>



<div class="viewcode-block" id="gamma_visc_icb">
<a class="viewcode-back" href="../utils.html#utils.gamma_visc_icb">[docs]</a>
<span class="k">def</span> <span class="nf">gamma_visc_icb</span><span class="p">(</span><span class="n">ricb</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Axial viscous torque on the inner core, spherical. Take 2*real after multiplying by the solution vector</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n0</span><span class="o">+</span><span class="n">n0</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">symm</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>

        <span class="n">T</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">T0</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">T1</span> <span class="o">=</span> <span class="n">T</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">ricb</span>
        <span class="c1"># axial torque depends on the l=1, m=0 toroidal component only</span>
        <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n0</span><span class="p">:</span><span class="n">n0</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">R</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span> <span class="n">R</span><span class="o">*</span><span class="n">T1</span> <span class="o">-</span> <span class="n">T0</span> <span class="p">)</span>

    <span class="k">return</span> <span class="n">out</span></div>




<div class="viewcode-block" id="gamma_magnetic">
<a class="viewcode-back" href="../utils.html#utils.gamma_magnetic">[docs]</a>
<span class="k">def</span> <span class="nf">gamma_magnetic</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Axial magnetic torque on the mantle (spherical) when there is a thin conductive layer at bottom. Needs m=0 and symm=1.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">magnetic</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">m</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">symm</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">par</span><span class="o">.</span><span class="n">mantle</span><span class="o">==</span><span class="s1">&#39;TWA&#39;</span><span class="p">):</span>

        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">n0</span><span class="o">+</span><span class="n">n0</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">Tk</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)[:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
        <span class="n">h_cmb</span> <span class="o">=</span> <span class="n">B0_norm</span><span class="p">()</span> <span class="o">*</span> <span class="n">h0</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">B0</span><span class="p">,</span> <span class="p">[</span><span class="n">par</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">B0_l</span><span class="p">,</span> <span class="n">par</span><span class="o">.</span><span class="n">ricb</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">B0_l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Either uniform axial or dipole background field, induced magnetic field b is thus antisymmetric</span>

            <span class="c1"># the torque is prop. to the l=2 toroidal component of b</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n0</span><span class="p">:</span><span class="n">n0</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">h_cmb</span>

        <span class="k">elif</span> <span class="n">B0_l</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># Quadrupole background field, induced magnetic field b is thus symmetric</span>

            <span class="c1"># torque prop. to l=1 and l=3 toroidal component of b</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n0</span><span class="p">:</span><span class="n">n0</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span>          <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>     <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">h_cmb</span> <span class="c1"># l=1</span>
            <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">n0</span><span class="o">+</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">:</span> <span class="n">n0</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">par</span><span class="o">.</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span>  <span class="p">(</span><span class="mi">16</span><span class="o">*</span><span class="mi">18</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">35</span><span class="p">)</span> <span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">h_cmb</span> <span class="c1"># l=3</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="n">out</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Take the product between the output of this function and the solution for b to obtain the dimensionless torque</span>
    <span class="c1"># Then multiply by Elsasser*R_cmb^3*rho*eta to make the torque dimensional</span>
    <span class="c1"># (rho is the density and eta is the magnetic diffusivity, both of the fluid core).</span>

    <span class="k">return</span> <span class="n">out</span></div>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Jorge Martinez.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>